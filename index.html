<!DOCTYPE html>
<html lang="id">
<head>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/tewetech/keuanganplampang2/refs/heads/main/favicon-uang.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keuangan Mekar Plampang 2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================================================= */
        /* === Variabel dan Gaya Dasar Tema === */
        /* ================================================= */
        :root {
            /* Warna Dasar */
            --bg-primary: #f0f0f5; /* Latar Belakang Utama */
            --bg-card: rgba(255, 255, 255, 0.5); /* Latar Belakang Kartu Glassmorphism */
            --text-main: #333333; /* Teks Utama */
            --text-subtle: #666666; /* Teks Sekunder/Subtil */
            --accent-1: #08978b; /* Primer/Simpan (Hijau Teal) */
            --accent-2: #ff6932; /* Hapus (Oranye) */
            --accent-3: #08978B; /* Tab Aktif/Edit/Salin (Sama dengan accent-1) */
            --border-color: rgba(0, 0, 0, 0.1); /* Warna Batas */
            
            /* Dimensi */
            --glass-br: 8px; /* Radius Sudut Glassmorphism */
            --font-size-base: 0.75rem; /* Ukuran Font Dasar (text-xs) */
            --padding-base: 0.6em; /* Padding Dasar */

            /* Shadow & Warna Aksi */
            --shadow-light: rgba(0, 0, 0, 0.1); /* Bayangan Ringan */
            --color-delete: var(--accent-2); /* Warna Hapus */
            --color-save: var(--accent-1); /* Warna Simpan */
            --color-copy: var(--accent-3); /* Warna Salin */
            --color-edit: var(--accent-3); /* Warna Edit */
        }

        /* --- Gaya Umum untuk body --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
            min-height: 100vh;
            padding: 1em; 
            font-size: var(--font-size-base); /* Ukuran Font Dasar: 0.75rem (text-xs) */
        }
        
        /* --- Kontainer utama (glass-card) --- */
        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(6px) saturate(180%); 
            -webkit-backdrop-filter: blur(6px) saturate(180%);
            border: 1px solid var(--border-color);
            box-shadow: 0 3px 9px var(--shadow-light); 
            padding: 1em; 
            border-radius: var(--glass-br);
        }

        /* --- Kontainer Utama untuk batasan lebar (main-container) --- */
        .main-container {
            max-width: 540px; 
            margin-left: auto;
            margin-right: auto;
            space-y: 0.8em; 
        }
        
        /* --- Tombol Aksi Utama (btn-primary - untuk tombol Tambah Baru) --- */
        .btn-primary {
            background-color: var(--color-save); 
            color: white;
            font-weight: 600;
            border-radius: 5px; 
            padding: 0.5rem 1rem; 
            font-size: 0.8rem; 
            box-shadow: 0 1px 4px rgba(8, 151, 139, 0.3); 
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #046c63; 
            transform: translateY(-1px);
        }
        
        /* === Gaya Tombol Hapus (btn-delete - untuk Modal Hapus) === */
        .btn-delete {
            background-color: var(--color-delete); 
            color: white;
            font-weight: 600;
            border-radius: 5px; 
            box-shadow: 0 1px 4px rgba(255, 105, 50, 0.3); 
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-delete:hover:not(:disabled) {
            background-color: #e04a1f; 
            transform: translateY(-1px);
        }

        /* --- Tombol Aksi Tabel (Edit/Hapus/Simpan/Batal Inline) --- */
        .btn-table-action {
            /* Membuat tombol lebih kecil dan merata */
            font-size: 0.7rem; 
            padding: 0.3rem; 
            width: 1.6rem; 
            height: 1.6rem; 
            border-radius: 3px; 
            color: white; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
        }

        /* --- Gaya Input dan Select --- */
        .gaya-input-theme {
            border: 1px solid var(--border-color);
            border-radius: 5px; 
            padding: 0.5rem; 
            font-size: 0.75rem; /* text-xs */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background-color: #fcfcfc;
        }

        /* --- Gaya Tabel --- */
        .data-table thead th {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-subtle);
            font-weight: 600;
            font-size: 0.7rem; /* Ukuran font header tabel */
            padding: 0.5rem 0.6rem; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            background-color: white; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
            /* REVISI: Pastikan judul kolom rata tengah (atau rata kiri untuk Keterangan, sesuai HTML) */
            text-align: center;
        }
        
        .data-table tbody td {
            padding: 0.5rem 0.6rem; 
            font-size: 0.75rem; /* Ukuran font isi sel tabel (text-xs) */
            vertical-align: middle; 
            color: var(--text-main); 
            /* Default untuk isi sel data: Rata Kiri */
            text-align: left;
        }
        
        /* --- REVISI: Pengaturan Rata Tengah/Kanan untuk Isi Kolom --- */
        /* Kolom ID (Kolom ke-1) - Hidden */
        .data-table tbody td:nth-child(1) {
            display: none;
        }
        /* Kolom TANGGAL (Kolom ke-2) */
        .data-table tbody td:nth-child(2) {
            text-align: center; 
        }
        /* Kolom KETERANGAN (Kolom ke-3) - Tetap Rata Kiri */
        .data-table tbody td:nth-child(3) {
            text-align: left;
        }
        /* Kolom PEMASUKAN, PENGELUARAN, SALDO (Kolom ke-4, ke-5, ke-6) */
        .data-table tbody td:nth-child(4),
        .data-table tbody td:nth-child(5),
        .data-table tbody td:nth-child(6) {
            text-align: right; /* Rata Kanan untuk nominal uang */
        }
        /* Kolom AKSI (Kolom ke-7) */
        .data-table tbody td:nth-child(7) {
            text-align: center;
        }
        /* --- Akhir Revisi Pengaturan Rata Tengah/Kanan --- */


        /* Mengganti baris ganjil/genap dengan gaya default agar lebih bersih */
        .data-table tbody tr:nth-child(odd) { background-color: white; }
        .data-table tbody tr:nth-child(even) { background-color: var(--bg-primary); }
        .data-table tbody tr:hover { background-color: #e3f2fd; }

        /* --- Gaya Scrollable Data --- */
        .scrollable-data {
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid var(--border-color);
            border-radius: var(--glass-br);
        }

        /* --- Gaya Tombol Bulan --- */
        .btn-month-theme {
            padding: 0.4rem 0.6rem; 
            font-weight: 500; 
            border-radius: 5px; 
            color: var(--text-subtle);
            font-size: 0.75rem; /* text-xs */
            transition: all 0.2s ease;
            background-color: #e0e0e0; 
            border: 1px solid var(--border-color);
        }
        .btn-month-theme:hover { 
            background-color: #ccc; 
            color: var(--text-main); 
            transform: translateY(-1px);
        }
        .btn-month-theme.aktif {
            background-color: var(--accent-1); 
            color: white;
            border-color: var(--accent-1);
            box-shadow: 0 1px 4px rgba(8, 151, 139, 0.3); 
        }
        .btn-month-theme.aktif:hover {
            background-color: var(--accent-1); 
            color: white;
        }

        /* --- Gaya Modal --- */
        .modal {
            transition: all 0.3s ease-out;
            opacity: 0;
            pointer-events: none;
            display: flex; 
        }
        .modal-open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: white;
            border-radius: 10px; 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            padding: 1.2em; 
            transform: translateY(-15px); 
            transition: transform 0.3s ease-out;
        }
        .modal-open .modal-content {
            transform: translateY(0);
        }

        /* --- Gaya Baris Input/Edit --- */
        #baris-input-baru {
            background-color: #e6fffb !important; /* Warna latar belakang tema: Minty */
        }
        .baris-edit-aktif {
            background-color: #fffbe6 !important; /* Warna latar belakang tema: Kuning lembut */
        }
        
        /* Gaya tambahan untuk menyembunyikan Kolom ID Transaksi */
        .hidden-ts-col {
            display: none;
        }

        /* --- Gaya untuk Tombol yang Terkunci --- */
        .locked-action {
            /* Warna yang lebih kusam dan kursor disabled */
            background-color: #9ca3af !important;
            cursor: not-allowed !important;
            box-shadow: none !important;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div class="main-container mx-auto p-4 space-y-4"> 
        
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-extrabold text-[var(--accent-1)]">
                <i class="fas fa-chart-line mr-2"></i> KEUANGAN MEKAR
            </h1>
            <p class="text-[var(--text-subtle)] mt-1 font-['JetBrains_Mono',_monospace] text-xs">
                Keuangan Mekar Plampang 2 | By Tewe Tech
            </p>
        </header>

        <div class="glass-card p-3 mb-2 text-center text-xs font-bold font-['JetBrains_Mono',_monospace]">
            <span id="adminStatus" class="text-red-600">
                <i class="fas fa-lock mr-1"></i> MODE ADMIN NONAKTIF
            </span>
            <button onclick="showAdminModal()" id="toggleAdminBtn" class="ml-2 py-0.5 px-2 text-xs rounded-full bg-gray-200 hover:bg-gray-300 transition duration-150">
                <i class="fas fa-key mr-1"></i> Aktifkan
            </button>
        </div>

        <div class="glass-card p-4 mb-4">
            <div class="mb-4">
                <p class="text-sm text-[var(--text-main)] mb-2 font-semibold">
                    <i class="fas fa-calendar-check mr-2"></i> Pilih Bulan :
                </p>
                <div id="filterBulanContainer" class="grid grid-cols-6 sm:grid-cols-12 gap-1.5">
                    </div>
            </div>

            <div id="kartuSaldo" class="glass-card p-4 rounded-xl shadow-inner text-center transition duration-300">
                <p class="text-xs opacity-90 font-['JetBrains_Mono',_monospace] text-gray-500">SALDO AKHIR BULAN INI:</p>
                <p id="akhirSaldo" class="text-3xl font-extrabold mt-1 font-['JetBrains_Mono',_monospace] text-gray-500">Rp 0</p>
            </div>
        </div>

        <div class="glass-card p-4 overflow-x-auto relative">
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-sm md:text-md text-[var(--text-main)] font-semibold">
                    <i class="fas fa-receipt mr-2"></i> Rincian Transaksi :
                </h2>
                <div class="flex space-x-2">
                    <button 
                        id="tombolSimpanCsv" 
                        class="btn-primary flex items-center justify-center text-xs rounded-full transform transition duration-200"
                        style="width: 40px; height: 40px; font-size: 0.8rem; padding: 0;"
                        title="Simpan Data Transaksi Bulan Ini ke CSV"
                        onclick="exportToCSV()"
                    >
                        <i class="fas fa-download"></i>
                    </button>
                    <button 
                        id="tombolTambahBaru" 
                        class="btn-primary rounded-full flex items-center justify-center transform transition duration-200 locked-action" 
                        title="Aktifkan Mode Admin untuk Tambah Baru"
                        style="width: 40px; height: 40px; font-size: 1rem; padding: 0;"
                        onclick="checkAdminStatus(addRowToTable)"
                    >
                        <i class="fas fa-plus-circle"></i>
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto scrollable-data shadow-inner bg-white bg-opacity-80">
                <table class="min-w-full data-table border-collapse">
                    <thead class="sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-2 text-xs uppercase tracking-wider hidden-ts-col">ID TRANSAKSI (TS)</th> 
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">TANGGAL</th>
                            <th class="px-6 py-2 text-center text-xs uppercase tracking-wider">KETERANGAN</th> 
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">PEMASUKAN</th>
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">PENGELUARAN</th>
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">SALDO</th>
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">AKSI</th> 
                        </tr>
                    </thead>
                    <tbody id="tabelDataTransaksi" class="divide-y divide-[var(--border-color)]">
                        <tr><td colspan="7" class="text-center py-4 text-[var(--text-subtle)]">Silakan pilih bulan di atas.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalAdmin" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="modal-content p-4 w-11/12 max-w-xs">
            <h3 class="text-lg font-bold mb-3 flex items-center text-[var(--accent-3)]">
                <i class="fas fa-user-shield mr-2"></i> Akses Administrator
            </h3>
            <p class="mb-3 text-[var(--text-main)] text-sm">Masukkan password untuk mengaktifkan mode Edit/Input.</p>
            <input 
                type="password" 
                id="adminPasswordInput" 
                placeholder="Password"
                class="gaya-input-theme w-full mb-4" 
                onkeypress="if(event.key === 'Enter') authenticateAdmin()"
            >
            <p id="passwordError" class="text-red-500 text-xs mb-3 hidden">Password salah. Coba lagi.</p>
            <div class="flex justify-end space-x-2">
                <button onclick="closeAdminModal()" class="bg-gray-200 text-gray-700 font-semibold py-1.5 px-3 rounded-md text-sm hover:bg-gray-300 transition duration-150">
                    <i class="fas fa-times mr-1"></i> Batal
                </button>
                <button onclick="authenticateAdmin()" class="btn-primary text-white font-semibold py-1.5 px-3 rounded-md shadow-md hover:shadow-lg transition duration-150 ease-in-out text-sm">
                    <i class="fas fa-key mr-1"></i> Masuk
                </button>
            </div>
        </div>
    </div>

    <div id="lapisanMemuat" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="modal-content p-4 w-full max-w-xs">
            <div class="flex items-center justify-center space-x-2">
                <svg class="animate-spin h-5 w-5 text-[var(--accent-1)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm font-medium text-[var(--text-main)]">Memuat Data...</span>
            </div>
        </div>
    </div>

    <div id="wadahToast" class="fixed bottom-4 right-4 space-y-2 z-50">
    </div>

    <div id="modalHapus" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="modal-content p-4 w-11/12 max-w-xs">
            <h3 class="text-lg font-bold mb-3 flex items-center text-[var(--color-delete)]">
                <i class="fas fa-exclamation-triangle mr-2"></i> Konfirmasi Penghapusan
            </h3>
            <p id="modalPesan" class="mb-4 text-[var(--text-main)] text-sm">Anda yakin ingin menghapus transaksi ini?</p>
            <div class="flex justify-end space-x-2">
                <button id="tombolBatalHapus" class="bg-gray-200 text-gray-700 font-semibold py-1.5 px-3 rounded-md text-sm hover:bg-gray-300 transition duration-150">
                    <i class="fas fa-times mr-1"></i> Batal
                </button>
                <button id="tombolKonfirmasiHapus" class="btn-delete text-white font-semibold py-1.5 px-3 rounded-md shadow-md hover:shadow-lg transition duration-150 ease-in-out text-sm">
                    <i class="fas fa-trash-alt mr-1"></i> Ya, Hapus
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // KONFIGURASI APLIKASI
        // ====================================================================
        
        // URL DEPLOYMENT Apps Script Anda (HARAP GANTI dengan URL Anda)
        const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwkoQPswh47R94GcTuSyU32H2Bt6Jg6Bbiojxd4aRQx91gMV_ktIOJt8-Fh3pGV0MqM/exec"; 

        // DAFTAR NAMA BULAN
        const MONTH_DATA = [
            { full: "Januari", short: "Jan" }, { full: "Februari", short: "Feb" }, { full: "Maret", short: "Mar" }, 
            { full: "April", short: "Apr" }, { full: "Mei", short: "Mei" }, { full: "Juni", short: "Jun" }, 
            { full: "Juli", short: "Jul" }, { full: "Agustus", short: "Agu" }, { full: "September", short: "Sep" }, 
            { full: "Oktober", short: "Okt" }, { full: "November", short: "Nov" }, { full: "Desember", short: "Des" }
        ];
        
        // VARIABEL STATUS ADMINISTRATOR
        const ADMIN_PASSWORD = "dataplp2"; // Password Admin
        let isAdmin = false; // Status mode Admin
        let pendingAction = null; // Menyimpan fungsi yang akan dijalankan setelah autentikasi

        // Variabel Status Aplikasi
        let isEditing = false; // Status apakah sedang dalam mode edit
        let isAddingNew = false; // Status apakah sedang dalam mode tambah baru
        let originalRowContent = null; // Menyimpan konten baris asli saat edit
        let currentSelectedMonth = MONTH_DATA[new Date().getMonth()].full; // Bulan yang saat ini dipilih
        let transactionIdToDelete = null; // ID transaksi yang akan dihapus
        let finalBalanceValue = 0; // Nilai Saldo Akhir Bulan (diperbarui di fetchData)
        
        // Referensi DOM
        const filterBulanContainer = document.getElementById('filterBulanContainer'); // Kontainer tombol bulan
        const tabelDataTransaksi = document.getElementById('tabelDataTransaksi');     // Body tabel transaksi
        const lapisanMemuat = document.getElementById('lapisanMemuat');             // Modal loading
        const akhirSaldoEl = document.getElementById('akhirSaldo');                 // Elemen saldo akhir
        const tombolTambahBaru = document.getElementById('tombolTambahBaru');         // Tombol tambah baru
        const wadahToast = document.getElementById('wadahToast');                     // Wadah notifikasi toast
        const modalHapus = document.getElementById('modalHapus');                     // Modal konfirmasi hapus
        const tombolKonfirmasiHapus = document.getElementById('tombolKonfirmasiHapus'); // Tombol konfirmasi hapus di modal
        const tombolBatalHapus = document.getElementById('tombolBatalHapus');           // Tombol batal hapus di modal
        // DOM Admin
        const modalAdmin = document.getElementById('modalAdmin');                     // Modal admin
        const adminPasswordInput = document.getElementById('adminPasswordInput');     // Input password admin
        const passwordError = document.getElementById('passwordError');               // Pesan error password
        const adminStatusEl = document.getElementById('adminStatus');                 // Teks status admin
        const toggleAdminBtn = document.getElementById('toggleAdminBtn');             // Tombol toggle admin
        // DOM Tambahan untuk Export CSV
        const tombolSimpanCsv = document.getElementById('tombolSimpanCsv');         // Tombol export CSV


        // ====================================================================
        // FUNGSI ADMINISTRATOR
        // ====================================================================

        /** Menampilkan modal password administrator */
        function showAdminModal() {
            if (isAdmin) {
                // Jika sudah aktif, nonaktifkan
                isAdmin = false;
                updateAdminUI();
                showToast("Mode Administrator dinonaktifkan.", 'accent-3');
                return;
            }
            // Jika belum aktif, tampilkan modal
            adminPasswordInput.value = '';
            passwordError.classList.add('hidden');
            modalAdmin.classList.remove('hidden');
            modalAdmin.classList.add('modal-open');
            setTimeout(() => adminPasswordInput.focus(), 300);
        }

        /** Menutup modal password administrator */
        function closeAdminModal() {
            modalAdmin.classList.remove('modal-open');
            modalAdmin.classList.add('hidden');
            pendingAction = null; // Hapus aksi tertunda
        }

        /** Memeriksa password dan mengaktifkan mode Admin */
        function authenticateAdmin() {
            const inputPass = adminPasswordInput.value.trim();
            if (inputPass === ADMIN_PASSWORD) {
                isAdmin = true;
                closeAdminModal();
                updateAdminUI();
                showToast("Mode Administrator berhasil diaktifkan!", 'success');
                
                // Jika ada aksi tertunda, jalankan
                if (pendingAction) {
                    // Berikan jeda sebentar agar modal sempat tertutup
                    setTimeout(() => {
                        pendingAction();
                        pendingAction = null;
                    }, 50); 
                }
            } else {
                passwordError.classList.remove('hidden');
                adminPasswordInput.value = '';
                adminPasswordInput.focus();
                showToast("Password salah!", 'error');
            }
        }

        /** Memeriksa status Admin sebelum menjalankan fungsi krusial */
        function checkAdminStatus(action, actionId = null) {
            if (isAdmin) {
                // Jika sudah Admin, langsung jalankan aksi
                action(actionId);
            } else {
                // Jika belum Admin, simpan aksi dan tampilkan modal password
                pendingAction = actionId ? () => action(actionId) : action;
                showAdminModal();
            }
        }

        /** Memperbarui tampilan UI sesuai status Admin (kunci tombol) */
        function updateAdminUI() {
            // 1. Tombol Tambah Baru
            tombolTambahBaru.classList.toggle('locked-action', !isAdmin);
            tombolTambahBaru.title = isAdmin ? "Tambah Transaksi Baru" : "Aktifkan Mode Admin untuk Tambah Baru";

            // 2. Status Teks
            if (isAdmin) {
                adminStatusEl.innerHTML = '<i class="fas fa-lock-open mr-1"></i> MODE ADMIN AKTIF';
                adminStatusEl.classList.remove('text-red-600');
                adminStatusEl.classList.add('text-[var(--accent-1)]');
                toggleAdminBtn.textContent = 'Nonaktifkan';
                toggleAdminBtn.classList.remove('bg-gray-200');
                toggleAdminBtn.classList.add('bg-red-400', 'text-white');
            } else {
                adminStatusEl.innerHTML = '<i class="fas fa-lock mr-1"></i> MODE ADMIN NONAKTIF';
                adminStatusEl.classList.add('text-red-600');
                adminStatusEl.classList.remove('text-[var(--accent-1)]');
                toggleAdminBtn.textContent = 'Aktifkan';
                toggleAdminBtn.classList.add('bg-gray-200');
                toggleAdminBtn.classList.remove('bg-red-400', 'text-white');
            }

            // 3. Tombol Aksi di Tabel (Render ulang atau perbarui kelas)
            const rows = tabelDataTransaksi.querySelectorAll('tr[data-id]');
            rows.forEach(row => {
                const editButton = row.querySelector('.btn-table-action[onclick*="startEdit"]');
                const deleteButton = row.querySelector('.btn-table-action[onclick*="showDeleteConfirmation"]');

                if (editButton) {
                    // Ganti logika klik langsung ke checkAdminStatus
                    editButton.onclick = () => checkAdminStatus(startEdit, row.dataset.id);
                    editButton.classList.toggle('locked-action', !isAdmin);
                    editButton.title = isAdmin ? "Edit Transaksi" : "Aktifkan Mode Admin untuk Edit";
                }
                if (deleteButton) {
                    const id = row.dataset.id;
                    // Ganti logika klik langsung ke checkAdminStatus
                    deleteButton.onclick = () => checkAdminStatus(showDeleteConfirmation, id);
                    deleteButton.classList.toggle('locked-action', !isAdmin);
                    deleteButton.title = isAdmin ? "Hapus Transaksi" : "Aktifkan Mode Admin untuk Hapus";
                }
            });
        }

        // ====================================================================
        // FUNGSI UTILITY & API CALLS
        // ====================================================================

        /** Mengirim data ke Google Apps Script */
        async function postToGS(data, method = 'POST') {
            let url = `${GOOGLE_APPS_SCRIPT_URL}?action=${data.action || 'READ_DATA'}`;
            const options = {
                method: method,
                redirect: 'follow',
                mode: 'cors'
            };

            const MAX_RETRIES = 3; // Jumlah maksimum percobaan ulang
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    if (method === 'POST') {
                        const formData = new FormData();
                        for (const key in data) {
                            // Konversi angka ke string untuk FormData
                            formData.append(key, typeof data[key] === 'number' ? String(data[key]) : data[key]);
                        }
                        options.body = formData;
                    } else {
                        // Jika GET, tambahkan data sebagai parameter URL
                        const params = new URLSearchParams(data);
                        url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
                    }

                    const response = await fetch(url, options);

                    if (response.status === 429) { // Terlalu Banyak Permintaan
                        if (i < MAX_RETRIES - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay)); // Eksponensial backoff
                            continue;
                        } else {
                            throw new Error(`Batas percobaan habis. Server terlalu sibuk.`);
                        }
                    }

                    if (!response.ok) {
                        throw new Error(`Permintaan HTTP gagal dengan status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.status === 'error') {
                        throw new Error(result.message || 'Operasi gagal di sisi server.');
                    }

                    return result;

                } catch (error) {
                    console.error("Kesalahan saat menghubungi Apps Script:", error);
                    if (i === MAX_RETRIES - 1) {
                        throw new Error(`Gagal memproses data setelah ${MAX_RETRIES} percobaan: ${error.message}`);
                    }
                }
            }
        }

        /** Menampilkan notifikasi toast */
        function showToast(message, type) {
            const container = wadahToast;
            let bgColor;
            let icon;

            // Tentukan warna dan ikon berdasarkan tipe
            if (type === 'success') {
                bgColor = 'bg-[var(--accent-1)]';
                icon = 'fa-check-circle';
            } else if (type === 'accent-3') {
                bgColor = 'bg-[#3b82f6]';
                icon = 'fa-info-circle';
            } else { // error
                bgColor = 'bg-[var(--accent-2)]';
                icon = 'fa-exclamation-circle';
            }

            const toast = document.createElement('div');
            toast.className = `p-2 rounded-lg shadow-xl ${bgColor} text-white transition-all transform duration-500 translate-y-2 opacity-0 flex items-center space-x-2 text-sm`;
            toast.innerHTML = `<i class="fas ${icon} text-lg"></i> <div>
                <p class="font-bold">${type === 'success' ? 'BERHASIL' : (type === 'accent-3' ? 'PERHATIAN' : 'GAGAL')}</p>
                <p class="mt-0.5 text-xs">${message}</p>
            </div>`;
            
            container.appendChild(toast);

            // Tampilkan toast
            setTimeout(() => {
                toast.classList.remove('translate-y-2', 'opacity-0');
            }, 50);

            // Sembunyikan dan hapus toast setelah 5 detik
            setTimeout(() => {
                toast.classList.add('translate-y-2', 'opacity-0');
                setTimeout(() => {
                    toast.remove();
                }, 500); 
            }, 5000); 
        }

        /** Menampilkan atau menyembunyikan lapisan memuat */
        function showLoading(state) {
            lapisanMemuat.classList.toggle('hidden', !state);
            lapisanMemuat.classList.toggle('modal-open', state);
        }

        /** Format angka menjadi format Rupiah */
        function formatRupiah(angka) {
            // Jika angka negatif, pastikan tanda minus ikut
            if (typeof angka !== 'number') return 'Rp 0';
            const sign = angka < 0 ? '-' : '';
            const absoluteAngka = Math.abs(angka);

            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });
            // Gabungkan tanda minus jika ada
            return sign + formatter.format(absoluteAngka).trim();
        }
        
        /** Mengubah format tanggal dari YYYY-MM-DD menjadi DD Bulan YYYY (contoh: 1 Agustus 2025) */
        function formatDateToIndonesian(dateString) {
            if (!dateString) return '';
            
            try {
                // Mencoba untuk membuat objek Date
                const date = new Date(dateString);

                // Periksa apakah tanggal valid
                if (isNaN(date)) {
                    // Jika tidak valid, coba parsing manual YYYY-MM-DD
                    const parts = dateString.match(/(\d{4})-(\d{2})-(\d{2})/);
                    if (parts) {
                        // Membuat objek Date dengan komponen terpisah untuk menghindari pergeseran zona waktu
                        return new Date(parts[1], parts[2] - 1, parts[3]).toLocaleDateString('id-ID', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                        });
                    }
                    return dateString; // Fallback jika parsing manual gagal
                }

                // Menggunakan Intl.DateTimeFormat untuk format lokal Indonesia
                return date.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

            } catch (error) {
                console.error("Gagal memformat tanggal:", error);
                return dateString; // Kembali ke string asli jika gagal
            }
        }


        /** Mengambil data dari Apps Script */
        async function fetchData() {
            if (isEditing || isAddingNew) return; // Jangan fetch saat sedang edit/tambah

            showLoading(true);
            try {
                // Asumsi Apps Script akan mengembalikan initialBalance (saldo awal bulan)
                const result = await postToGS({ action: 'READ_DATA', month: currentSelectedMonth }, 'GET');
                
                // Ambil Saldo Awal
                const initialBalance = result.initialBalance || 0; 
                
                // Lanjutkan ke render tabel dengan saldo awal
                renderTable(result.data || [], initialBalance);
                
                // Saldo akhir sudah dihitung di renderTable dan disimpan di finalBalanceValue
                akhirSaldoEl.textContent = formatRupiah(finalBalanceValue);
                
            } catch (error) {
                showToast(`Gagal memuat data: ${error.message}`, 'error');
                tabelDataTransaksi.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">${error.message}</td></tr>`;
                akhirSaldoEl.textContent = 'Rp 0';
            } finally {
                showLoading(false);
            }
        }

        // ====================================================================
        // FUNGSI EXPORT CSV
        // ====================================================================

        /** Mengubah array data menjadi string CSV */
        function convertToCSV(dataArray) {
            // Menggunakan titik koma (;) sebagai pemisah kolom untuk kompatibilitas Excel Indonesia
            const DELIMITER = ';'; 

            // Fungsi untuk mengutip field jika mengandung delimiter, kutipan ganda, atau baris baru
            const escapeField = (field) => {
                if (typeof field === 'number') {
                    // Jika berupa angka, konversi ke string dan ganti titik desimal ke koma (standar Indonesia)
                    let numStr = String(field);
                    if (numStr.includes('.')) {
                        // Ganti titik desimal ke koma
                        numStr = numStr.replace('.', ','); 
                    }
                    return numStr; 
                }
                
                let str = String(field).replace(/"/g, '""'); // Mengganti kutipan ganda dengan dua kutipan ganda
                // Hanya mengutip field jika mengandung delimiter, kutipan ganda, atau baris baru
                if (str.includes(DELIMITER) || str.includes('\n') || str.includes('"')) {
                    return `"${str}"`;
                }
                return str;
            };

            const header = ['Tanggal', 'Keterangan', 'Pemasukan', 'Pengeluaran', 'Sisa Saldo'];
            // Menggabungkan header menggunakan DELIMITER (titik koma)
            let csv = header.map(escapeField).join(DELIMITER) + '\n';

            dataArray.forEach(row => {
                const values = [
                    row.tanggal, 
                    row.keterangan, 
                    row.pemasukan, 
                    row.pengeluaran, 
                    row.saldo
                ];
                // Menggabungkan nilai menggunakan DELIMITER (titik koma)
                csv += values.map(escapeField).join(DELIMITER) + '\n';
            });

            return csv;
        }

        /** Memicu pengunduhan file CSV */
        function downloadCSV(csvString, filename) {
            const bom = '\ufeff'; // BOM (Byte Order Mark) untuk membantu Excel mengenali UTF-8 dan pemisah (;)
            
            // Membuat Blob dengan BOM dan tipe text/csv;charset=utf-8
            const blob = new Blob([bom + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            // Kompatibilitas browser
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast(`File ${filename} berhasil diunduh.`, 'success'); 
            } else {
                showToast("Browser Anda tidak mendukung pengunduhan otomatis.", 'error');
            }
        }
        
        /** Fungsi utama untuk mengumpulkan data tabel dan mengekspornya ke CSV */
        function exportToCSV() {
            showLoading(true);
            const rows = tabelDataTransaksi.querySelectorAll('tr[data-id]');
            const dataToExport = [];

            if (rows.length === 0) {
                showToast("Tidak ada data transaksi di bulan ini untuk diekspor.", 'accent-3');
                showLoading(false);
                return;
            }

            rows.forEach(row => {
                const cells = row.querySelectorAll('.data-cell');
                // cells[1] = Tanggal Indonesia (DD Bulan YYYY)
                // cells[2] = Keterangan
                // cells[3] = Pemasukan (Format Rupiah)
                // cells[4] = Pengeluaran (Format Rupiah)
                // cells[5] = Sisa Saldo (Format Rupiah)

                // Fungsi lokal untuk menghapus format Rupiah dan mengembalikan angka (atau 0 jika gagal)
                const cleanRupiah = (text) => {
                    if (!text) return 0;
                    // Hapus 'Rp', spasi, tanda minus, dan semua separator ribuan (titik)
                    let cleanText = String(text).replace(/Rp\s*/g, '').replace(/\./g, '').replace(/-/g, '').trim();
                    // Ganti koma (pemisah desimal Indonesia) menjadi titik (pemisah desimal JS/CSV)
                    cleanText = cleanText.replace(',', '.'); 
                    // Gunakan parseFloat untuk mendapatkan nilai numerik (bisa negatif)
                    const num = parseFloat(cleanText.replace(/\s/g, '')) || 0;
                    return num;
                };

                // Ambil data yang sudah diformat untuk tampilan (Tanggal, Keterangan)
                const tanggalIndo = cells[1].textContent.trim();
                const keterangan = cells[2].textContent.trim();
                
                // Konversi nilai Rupiah kembali ke angka biasa (float)
                const pemasukanVal = cleanRupiah(cells[3].textContent.trim());
                const pengeluaranVal = cleanRupiah(cells[4].textContent.trim());
                const saldoVal = cleanRupiah(cells[5].textContent.trim());

                dataToExport.push({
                    tanggal: tanggalIndo, // Format Tanggal Indonesia
                    keterangan: keterangan,
                    pemasukan: pemasukanVal, // Nilai float/angka
                    pengeluaran: pengeluaranVal, // Nilai float/angka
                    saldo: saldoVal // Nilai float/angka
                });
            });

            const csvContent = convertToCSV(dataToExport);
            const filename = `Keuangan_Plampang2_${currentSelectedMonth}_${new Date().getFullYear()}.csv`;
            
            downloadCSV(csvContent, filename);
            showLoading(false);
        }

        // ====================================================================
        // FUNGSI TAMPILAN & INPUT
        // ====================================================================

        /** Membuat elemen tombol filter bulan */
        function createMonthButton(monthName) {
            const btn = document.createElement('button');
            btn.className = `btn-month-theme ${monthName === currentSelectedMonth ? 'aktif' : ''}`;
            btn.textContent = monthName.substring(0, 3);
            btn.setAttribute('data-month', monthName);
            btn.onclick = () => selectMonth(monthName);
            return btn;
        }

        /** Mengubah bulan yang dipilih */
        function selectMonth(monthName) {
            if (isEditing || isAddingNew) {
                showToast("Selesaikan aksi Edit/Tambah terlebih dahulu.", 'accent-3');
                return;
            }
            if (currentSelectedMonth === monthName) return;

            currentSelectedMonth = monthName;
            
            // Perbarui tampilan tombol
            document.querySelectorAll('.btn-month-theme').forEach(btn => {
                btn.classList.toggle('aktif', btn.getAttribute('data-month') === monthName);
            });

            fetchData();
        }

        /** Render data ke tabel HTML */
        function renderTable(data, initialBalance) {
            tabelDataTransaksi.innerHTML = ''; // Kosongkan tabel
            
            let currentBalance = initialBalance; // Mulai dari saldo awal bulan

            if (data.length === 0) {
                tabelDataTransaksi.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-[var(--text-subtle)]">Tidak ada data transaksi di bulan ini.</td></tr>`;
                // Jika data kosong, saldo akhir adalah saldo awal
                finalBalanceValue = initialBalance; 
                updateAdminUI(); // Perbarui UI admin (kunci tombol)
                return;
            }

            data.forEach(rowData => {
                // Skema data: [id, tanggal, keterangan, pemasukan, pengeluaran]
                const [id, tanggalYMD, keterangan, pemasukanText, pengeluaranText] = rowData;
                
                // Pastikan nilai Pemasukan/Pengeluaran adalah angka
                const pemasukan = parseFloat(pemasukanText) || 0;
                const pengeluaran = parseFloat(pengeluaranText) || 0;

                // Hitung Saldo Baris
                currentBalance = currentBalance + pemasukan - pengeluaran;

                // Format Tanggal untuk Tampilan
                const formattedDate = formatDateToIndonesian(tanggalYMD);

                const newRow = document.createElement('tr');
                newRow.setAttribute('data-id', id);
                
                // Perhatikan: Penataan rata kanan/tengah/kiri sudah diatur di bagian CSS <style> di atas
                newRow.innerHTML = `
                    <td class="data-cell p-1 hidden-ts-col">${id}</td>
                    <td class="data-cell p-1">${formattedDate}</td> 
                    <td class="data-cell p-1">${keterangan}</td> 
                    <td class="data-cell p-1 text-[var(--accent-1)] font-['JetBrains_Mono',_monospace]">${formatRupiah(pemasukan)}</td>
                    <td class="data-cell p-1 text-[var(--accent-2)] font-['JetBrains_Mono',_monospace]">${formatRupiah(pengeluaran)}</td>
                    <td class="data-cell p-1 font-bold font-['JetBrains_Mono',_monospace]">${formatRupiah(currentBalance)}</td>
                    <td class="data-cell p-1 whitespace-nowrap">
                        <button onclick="checkAdminStatus(startEdit, '${id}')" class="btn-table-action bg-[var(--color-edit)] hover:bg-[#077d73] mr-1 locked-action" title="Aktifkan Mode Admin untuk Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="checkAdminStatus(showDeleteConfirmation, '${id}')" class="btn-table-action bg-[var(--color-delete)] hover:bg-[#e04a1f] locked-action" title="Aktifkan Mode Admin untuk Hapus">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tabelDataTransaksi.appendChild(newRow);
            });
            
            // Simpan Saldo Akhir
            finalBalanceValue = currentBalance; 

            // Pastikan UI admin diperbarui setelah render
            updateAdminUI(); 
        }

        /** Membuat baris input/edit */
        function createInputRow(rowData = null) {
            const isEdit = rowData !== null;
            
            // Data rowData: [timestamp, tanggalYMD, keterangan, pemasukan, pengeluaran, id]
            const id = isEdit ? rowData[5] : new Date().getTime(); 
            const tanggalVal = isEdit ? rowData[1] : new Date().toISOString().substring(0, 10); 
            const keteranganVal = isEdit ? rowData[2] : '';
            const pemasukanVal = isEdit ? rowData[3] : '';
            const pengeluaranVal = isEdit ? rowData[4] : '';
            
            const action = isEdit ? `updateData('${id}')` : 'saveNewData()';
            const inputRow = document.createElement('tr');
            inputRow.id = isEdit ? `edit-row-${id}` : 'baris-input-baru';
            inputRow.className = isEdit ? 'baris-edit-aktif' : '';

            // Perhatikan ID input menggunakan ID Transaksi (timestamp) agar unik: inputTanggal${id}
            inputRow.innerHTML = `
                <td class="data-cell p-1 hidden-ts-col">${id}</td>
                <td class="data-cell p-1">
                    <input type="date" value="${tanggalVal}" class="gaya-input-theme w-full text-center" id="inputTanggal${id}" required>
                </td>
                <td class="data-cell p-1">
                    <input type="text" value="${keteranganVal}" placeholder="Keterangan transaksi..." class="gaya-input-theme w-full" id="inputKeterangan${id}" required>
                </td>
                <td class="data-cell p-1">
                    <input type="number" value="${pemasukanVal}" placeholder="0" class="gaya-input-theme w-full text-right" id="inputPemasukan${id}" min="0">
                </td>
                <td class="data-cell p-1">
                    <input type="number" value="${pengeluaranVal}" placeholder="0" class="gaya-input-theme w-full text-right" id="inputPengeluaran${id}" min="0">
                </td>
                <td class="data-cell p-1 font-bold text-right">
                    -
                </td>
                <td class="data-cell p-1 text-center whitespace-nowrap">
                    <button onclick="${action}" class="btn-table-action bg-[var(--accent-1)] hover:bg-[#046c63] mr-1" title="${isEdit ? 'Simpan Perubahan' : 'Simpan Transaksi'}">
                        <i class="fas fa-save"></i>
                    </button>
                    <button onclick="cancelAction()" class="btn-table-action bg-gray-500 hover:bg-gray-600" title="Batal">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;
            
            return inputRow;
        }

        /** Mengganti baris tabel dengan form input saat Edit */
        function startEdit(id) {
            if (isEditing || isAddingNew) {
                showToast("Selesaikan aksi yang sedang berlangsung terlebih dahulu.", 'accent-3');
                return;
            }

            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;

            // Pastikan bukan baris input baru 
            if (row.id === 'baris-input-baru') return; 

            const cells = row.querySelectorAll('.data-cell');
            
            // Ambil data dari sel
            const timestamp = cells[0].textContent.trim();
            const tanggalIndo = cells[1].textContent.trim(); // Format DD Bulan YYYY
            const keterangan = cells[2].textContent.trim();
            const pemasukanText = cells[3].textContent.trim(); // Format Rupiah
            const pengeluaranText = cells[4].textContent.trim(); // Format Rupiah
            
            // FUNGSI UTILITY LOKAL
            // Parsing balik tanggal dari DD Bulan YYYY ke YYYY-MM-DD
            const convertIndoToYMD = (indoDate) => {
                try {
                    // Coba buat objek Date dengan format ID
                    const date = new Date(indoDate.replace(/(\d{1,2})\s+(\w+)\s+(\d{4})/, '$2 $1, $3'));
                    if (isNaN(date)) return new Date().toISOString().substring(0, 10);

                    // Konversi ke format YYYY-MM-DD yang dibutuhkan oleh input type="date"
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;

                } catch (e) {
                    return new Date().toISOString().substring(0, 10); // Fallback ke tanggal hari ini YYYY-MM-DD
                }
            };


            // Mengatasi parsing angka Rupiah (Rp1.000.000)
            const unformatRupiah = (text) => {
                if (!text) return '';
                // Hapus 'Rp', spasi, tanda minus, dan semua titik/koma (separator ribuan)
                let cleanText = String(text).replace(/Rp\s*/g, '').replace(/[\.,]/g, '').replace(/-/g, '').trim();
                // Menggunakan parseFloat dan fallback ke string kosong 
                const num = parseFloat(cleanText);
                return isNaN(num) ? '' : num;
            };
            
            // Gunakan fungsi konversi balik tanggal
            const tanggalInput = convertIndoToYMD(tanggalIndo); // YYYY-MM-DD format untuk input type="date"

            // Data yang akan dikirim ke createInputRow
            const rowDataForEdit = [
                timestamp, 
                tanggalInput, 
                keterangan, 
                unformatRupiah(pemasukanText), // Nilai numerik tanpa format
                unformatRupiah(pengeluaranText), // Nilai numerik tanpa format
                id // Transaction ID
            ];

            // Simpan baris asli
            originalRowContent = row.cloneNode(true);

            // Ganti baris dengan input form
            const inputRow = createInputRow(rowDataForEdit);
            row.replaceWith(inputRow);

            isEditing = true;
            // Focus ke input pertama (Tanggal)
            document.getElementById(`inputTanggal${id}`).focus();
        }

        /** Menambahkan baris kosong untuk input data baru */
        function addRowToTable() {
            if (isEditing || isAddingNew) {
                showToast("Selesaikan aksi yang sedang berlangsung terlebih dahulu.", 'accent-3');
                return;
            }

            // Cek apakah tabel kosong (ada baris placeholder)
            const firstRow = tabelDataTransaksi.querySelector('tr');
            if (firstRow && firstRow.cells.length === 1 && firstRow.textContent.includes('Silakan pilih bulan')) {
                 tabelDataTransaksi.innerHTML = ''; // Hapus baris placeholder
            }

            const inputRow = createInputRow(null); // Data null = tambah baru
            
            // Tambahkan baris baru di paling atas
            tabelDataTransaksi.prepend(inputRow);
            
            isAddingNew = true;
            // Focus ke input pertama (Tanggal)
            document.getElementById('inputTanggal' + new Date().getTime()).focus();
        }

        /** Membatalkan aksi Edit/Tambah Baru */
        function cancelAction() {
            if (isEditing) {
                const editRow = document.getElementById(`edit-row-${originalRowContent.dataset.id}`);
                if (editRow) {
                    editRow.replaceWith(originalRowContent);
                    // Setelah pembatalan edit, pastikan tombol aksi diperbarui
                    updateAdminUI(); 
                }
                isEditing = false;
                originalRowContent = null;
            } else if (isAddingNew) {
                const newRow = document.getElementById('baris-input-baru');
                if (newRow) {
                    newRow.remove();
                }
                isAddingNew = false;
                // Jika setelah batal tabel kosong, tampilkan placeholder
                if (tabelDataTransaksi.children.length === 0) {
                     tabelDataTransaksi.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-[var(--text-subtle)]">Tidak ada data transaksi di bulan ini.</td></tr>`;
                }
            }
        }

        /** Mempersiapkan data untuk disimpan saat EDIT */
        function getEditRowData(id) {
            const tanggal = document.getElementById(`inputTanggal${id}`).value;
            const keterangan = document.getElementById(`inputKeterangan${id}`).value;
            const pemasukan = document.getElementById(`inputPemasukan${id}`).value;
            const pengeluaran = document.getElementById(`inputPengeluaran${id}`).value;

            // Validasi Sederhana
            if (!tanggal || !keterangan) {
                showToast("Tanggal dan Keterangan wajib diisi.", 'error');
                return null;
            }

            // Pastikan minimal salah satu Pemasukan/Pengeluaran terisi
            if (!pemasukan && !pengeluaran) {
                showToast("Setidaknya isi nilai Pemasukan atau Pengeluaran.", 'error');
                return null;
            }

            return {
                action: 'UPDATE_TRANSACTION',
                id: id,
                month: currentSelectedMonth,
                tanggal: tanggal, // Tanggal dikirim dalam format YYYY-MM-DD
                pemasukan: parseFloat(pemasukan) || 0,
                pengeluaran: parseFloat(pengeluaran) || 0,
                keterangan: keterangan, 
            };
        }

        /** Mempersiapkan data untuk disimpan saat TAMBAH BARU */
        function getNewRowData() {
            const id = document.getElementById('baris-input-baru').querySelector('td.hidden-ts-col').textContent.trim();
            const tanggal = document.getElementById(`inputTanggal${id}`).value;
            const keterangan = document.getElementById(`inputKeterangan${id}`).value;
            const pemasukan = document.getElementById(`inputPemasukan${id}`).value;
            const pengeluaran = document.getElementById(`inputPengeluaran${id}`).value;

            // Validasi Sederhana
            if (!tanggal || !keterangan) {
                showToast("Tanggal dan Keterangan wajib diisi.", 'error');
                return null;
            }

            // Pastikan minimal salah satu Pemasukan/Pengeluaran terisi
            if (!pemasukan && !pengeluaran) {
                showToast("Setidaknya isi nilai Pemasukan atau Pengeluaran.", 'error');
                return null;
            }

            return {
                action: 'ADD_TRANSACTION',
                id: id,
                month: currentSelectedMonth,
                tanggal: tanggal, // Tanggal dikirim dalam format YYYY-MM-DD
                pemasukan: parseFloat(pemasukan) || 0,
                pengeluaran: parseFloat(pengeluaran) || 0,
                keterangan: keterangan, 
            };
        }

        /** FUNGSI KRUSIAL: Menyimpan data yang sudah diedit ke Apps Script */
        async function updateData(id) {
            const data = getEditRowData(id);
            if (!data) return;

            showLoading(true);
            try {
                await postToGS(data);
                showToast(`Transaksi ID ${id} berhasil diperbarui.`, 'success');
                cancelAction(); // Batalkan form input edit
                fetchData(); // Muat ulang data untuk menampilkan saldo yang diperbarui
            } catch (error) {
                showToast(`Gagal memperbarui data: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        /** FUNGSI KRUSIAL: Menyimpan data baru ke Apps Script */
        async function saveNewData() {
            const data = getNewRowData();
            if (!data) return;

            showLoading(true);
            try {
                await postToGS(data);
                showToast('Transaksi baru berhasil ditambahkan.', 'success');
                cancelAction(); // Batalkan form input baru
                fetchData(); // Muat ulang data untuk menampilkan saldo yang diperbarui
            } catch (error) {
                showToast(`Gagal menyimpan data: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        /** Menampilkan modal konfirmasi hapus */
        function showDeleteConfirmation(id) {
            if (isEditing || isAddingNew) {
                showToast("Selesaikan aksi yang sedang berlangsung terlebih dahulu.", 'accent-3');
                return;
            }
            transactionIdToDelete = id;
            const row = document.querySelector(`tr[data-id="${id}"]`);
            // Ambil keterangan dari sel (indeks 2)
            const keterangan = row ? row.cells[2].textContent.trim() : 'Transaksi ini';
            
            document.getElementById('modalPesan').textContent = `Anda yakin ingin menghapus transaksi "${keterangan}" (ID: ${id})?`;
            modalHapus.classList.remove('hidden');
            modalHapus.classList.add('modal-open');
        }

        /** Menghapus transaksi (FUNGSI KRUSIAL) */
        async function deleteTransaction() {
            if (!transactionIdToDelete) return;

            // Tutup modal dan tampilkan loading
            modalHapus.classList.remove('modal-open');
            modalHapus.classList.add('hidden');
            showLoading(true);

            try {
                await postToGS({ action: 'DELETE_TRANSACTION', id: transactionIdToDelete, month: currentSelectedMonth });
                showToast(`Transaksi ID ${transactionIdToDelete} berhasil dihapus.`, 'success');
                fetchData(); // Muat ulang data untuk menampilkan saldo yang diperbarui
            } catch (error) {
                showToast(`Gagal menghapus data: ${error.message}`, 'error');
            } finally {
                showLoading(false);
                transactionIdToDelete = null; 
            }
        }

        // ====================================================================
        // INISIALISASI
        // ====================================================================

        /** Inisialisasi awal saat dokumen dimuat */
        function initialize() {
            // 1. Render Tombol Bulan
            MONTH_DATA.forEach(month => {
                filterBulanContainer.appendChild(createMonthButton(month.full));
            });

            // 2. Set event listener untuk konfirmasi hapus
            tombolKonfirmasiHapus.onclick = deleteTransaction;
            tombolBatalHapus.onclick = () => {
                modalHapus.classList.remove('modal-open');
                modalHapus.classList.add('hidden');
                transactionIdToDelete = null;
            };

            // 3. Muat data untuk bulan yang sedang berjalan
            fetchData();
            
            // 4. Update UI Admin Awal
            updateAdminUI();
        }

        // Jalankan inisialisasi setelah DOM dimuat
        document.addEventListener('DOMContentLoaded', initialize);
        
        // Expose fungsi ke scope global agar bisa diakses dari atribut onclick di HTML
        window.checkAdminStatus = checkAdminStatus;
        window.startEdit = startEdit;
        window.showDeleteConfirmation = showDeleteConfirmation;
        window.showAdminModal = showAdminModal;
        window.closeAdminModal = closeAdminModal;
        window.authenticateAdmin = authenticateAdmin;
        window.addRowToTable = addRowToTable;
        window.cancelAction = cancelAction;
        window.updateData = updateData; 
        window.saveNewData = saveNewData; 
        window.formatDateToIndonesian = formatDateToIndonesian; 
        // Expose fungsi baru untuk CSV
        window.exportToCSV = exportToCSV; 

    </script>
</body>
</html>
